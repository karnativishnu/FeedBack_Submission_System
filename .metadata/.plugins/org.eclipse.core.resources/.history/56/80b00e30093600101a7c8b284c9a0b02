package com.feedback.controller;

import com.feedback.model.Feedback;
import com.feedback.repository.FeedbackRepository;

import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.*;
import org.springframework.http.ResponseEntity;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.web.bind.annotation.*;

import java.util.Optional;

@RestController
@RequestMapping("/feedback")
@CrossOrigin(origins = "*")
public class FeedbackController {

    @Autowired
    private FeedbackRepository repository;

    @Autowired
    private JavaMailSender mailSender;

    // POST /feedback
    @PostMapping
    public ResponseEntity<?> submitFeedback(@Valid @RequestBody Feedback feedback) {
        feedback.setSubmittedAt(java.time.LocalDateTime.now());
        feedback.setStatus("Pending");
        return ResponseEntity.ok(repository.save(feedback));
    }

    // GET /feedback?page=0&size=5&search=abc
    @GetMapping
    public Page<Feedback> getFeedback(@RequestParam(defaultValue = "0") int page,
                                      @RequestParam(defaultValue = "5") int size,
                                      @RequestParam(required = false) String search) {
        Pageable pageable = PageRequest.of(page, size, Sort.by("submittedAt").descending());
        if (search != null && !search.isEmpty()) {
            return repository.findByNameContainingIgnoreCaseOrEmailContainingIgnoreCase(search, search, pageable);
        }
        return repository.findAll(pageable);
    }

    // DELETE /feedback/{id}
    @DeleteMapping("/{id}")
    public ResponseEntity<?> deleteFeedback(@PathVariable Long id) {
        if (repository.existsById(id)) {
            repository.deleteById(id);
            return ResponseEntity.ok("Deleted");
        } else {
            return ResponseEntity.notFound().build();
        }
    }

    // PUT /feedback/{id}/status?status=Reviewed
    @PutMapping("/{id}/status")
    public ResponseEntity<?> updateStatus(@PathVariable Long id, @RequestParam String status) {
        Optional<Feedback> optional = repository.findById(id);
        if (optional.isPresent()) {
            Feedback feedback = optional.get();
            feedback.setStatus(status);
            Feedback updated = repository.save(feedback);
            return ResponseEntity.ok(updated);
        } else {
            return ResponseEntity.notFound().build();
        }
    }

    // POST /feedback/{id}/send-email
    @PostMapping("/{id}/send-email")
    public ResponseEntity<?> sendEmailToUser(@PathVariable Long id) {
        Optional<Feedback> optional = repository.findById(id);
        if (optional.isEmpty()) {
            return ResponseEntity.notFound().build();
        }

        Feedback feedback = optional.get();
        try {
            SimpleMailMessage message = new SimpleMailMessage();
            message.setTo(feedback.getEmail());
            message.setSubject("Your Feedback has been reviewed");
            message.setText("Hello " + feedback.getName() + ",\n\nThank you for your feedback.\n\n" +
                    "We have reviewed your message:\n\n" + feedback.getMessage() + "\n\n" +
                    "Status: " + feedback.getStatus() + "\n\nBest regards,\nSupport Team");
            mailSender.send(message);
            return ResponseEntity.ok("Email sent successfully");
        } catch (Exception e) {
            return ResponseEntity.internalServerError().body("Email sending failed: " + e.getMessage());
        }
    }
}
